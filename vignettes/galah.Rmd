---
title: "galah"
author: "Matilda Stevenson"
date: '`r Sys.Date()`'
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{galah}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include=FALSE}
library(knitr)
options(width=120)
```

## Installation

Development version from GitHub:

```{r eval=FALSE}
install.packages("remotes")
remotes::install_github("AtlasOfLivingAustralia/galah")
```

On Linux you will first need to ensure that `libcurl` and `v8` (version <= 3.15) are installed on your system --- e.g. on Ubuntu/Debian, open a terminal and do:

```{sh eval=FALSE}
sudo apt-get install libcurl4-openssl-dev libv8-3.14-dev
```

## Example usage

Install packages for the examples, if required.
```{r message=FALSE}
to_install <- c("dplyr", "ggplot2", "ozmaps", "sf")
to_install <- to_install[!sapply(to_install, requireNamespace, quietly=TRUE)]
if(length(to_install)>0)
    install.packages(to_install, repos="https://cran.csiro.au/")

library(dplyr)
library(ggplot2)
library(ozmaps)
library(sf)
library(galah)
```

### Taxon information
`ala_taxa()` provides information on one or more taxa. It can take either a
scientific name (default), or a unique taxon identifier. 
The output of `ala_taxa()` can be provided to `ala_counts()` and `ala_occurrences()` in the `taxa` argument
to filter by taxa.

#### Scientific name lookup
```{r}
# A single taxa
ala_taxa("Dasyurus viverrinus")
```

`ala_taxa()` can return record counts for taxa with `include_counts = TRUE`, and the child concepts for taxa with `return_children = TRUE`.
```{r}
banksia <- ala_taxa(list(genus = "Banksia"), return_children = TRUE, include_counts = TRUE)

# Select only the species-level taxa, sort by count, and display the top 5
top5_banksia <- banksia %>% filter(rank == "species") %>%
  arrange(desc(count)) %>%
  select(scientific_name, taxon_concept_id, count) %>%
  head(n = 5)

top5_banksia
```

#### Taxon identifier lookup
Use `ala_taxa()` to lookup a taxon id
```{r}
id <- "urn:lsid:biodiversity.org.au:afd.taxon:d315deea-822c-4f2c-b439-da33d6af5fd6"
ala_taxa(term = id, term_type = "identifier")
```

### Occurrence data
Once you have retrieved taxon information, you can use this to search for occurrence
records with `ala_occurrences()`. 
To download occurrence data you will need to specify your email in `ala_config()`. This email must be associated with an active ALA account. See more information in the [config section](#config)
```{r include = FALSE}
ala_config(email = "ala4r@ala.org.au", preserve = TRUE)
```

```{r eval = FALSE}
ala_config(email = your_email_here, preserve = TRUE)
```

```{r include = FALSE}
occ <- read.csv("banksia.csv")
```

Download occurrence records for 5 Banksia species
```{r eval = FALSE}
occ <- ala_occurrences(taxa = top5_banksia)
```

```{r}
head(occ)
```

#### Columns
There are a number of columns that can be returned with an occurrence dataset.
You can specify individual columns and/or column groups. To view the fields for
each group, see the documentation for `select_columns()`.
To view the list of available fields, run `find_fields()`.
```{r eval = FALSE}
cols <- select_columns("institutionID", group = "basic")
```

#### Filters
`ala_occurrences()` and `ala_counts()` can take filters to narrow down the
occurrence record search. `select_filters()` constructs the filters to pass to the `filters` option. It takes indvidual filters, in the form `field = value`, and/or a [data quality profile](#data-quality-profiles).
By default, a filter is included. To negate a filter, use `exclude()`.
To find filter names:
```{r eval = FALSE}
find_fields()
```
To find valid values for a filter:
```{r eval = FALSE}
find_field_values("kingdom")
```
To construct a set of filters:
```{r eval=FALSE}
# Filter with multiple values
filters <- select_filters(year = seq(2010, 2020),
                          basis_of_record = exclude("FossilSpecimen"))
```


##### Data quality profiles
Data quality profiles are predefined sets of filters which have been designed to help
users select fit-for-purpose records. More information about data profiles is available [here](https://support.ala.org.au/support/solutions/articles/6000240256-getting-started-with-the-data-quality-filters).
To view available data quality filters:
```{r eval = FALSE}
find_profiles()
```
To view the list of filters included in a profile:
```{r eval = FALSE}
find_profile_attributes("ALA")
```
To filter data using a data quality profile:
```{r}
filters <- select_filters(profile = "ALA")
```


### Summary statistics
`ala_counts()` provides summary counts on records in the ALA, without needing
to download all the records. It takes filters in the same structure as `ala_occurrences`.
The `group_by` parameter provides counts binned by the requested parameter.
```{r warning = FALSE}
# Total number of records in the ALA (with no data quality filters)
ala_counts()

# Total number of records, broken down by kindgom
ala_counts(group_by = "kingdom")

```


### Media downloads
```{r warning=FALSE, message=FALSE, eval = FALSE}
# Search for occurrences with images
filters <- select_filters(multimedia = "Image",
                          basis_of_record = "HumanObservation")
occ <- ala_occurrences(quoll$taxon_concept_id,
                       filters = filters)
images <- ala_media(head(occ$recordID, n = 5), download_dir = 'data/',
                    identifier_type = "occurrence")

# filter by licence type
images %>% filter(recognisedLicence == "CC BY-NC 4.0")
```


### Config

Various aspects of the galah package can be customized. To preserve
configuration for future sessions, set `preserve = TRUE`. This will write the
config to your `.Renviron` file.

#### Email
To download occurrence records, you will need to provide an email address
registered with the ALA. You can create an account [here](https://auth.ala.org.au/userdetails/registration/createAccount)

#### Caching
`galah` can cache most results to local files. This means that if the same code is run multiple times, the second and subsequent iterations will be faster. This will also reduce load on the ALA servers.

By default, this caching is session-based, meaning that the local files are stored in a temporary directory that is automatically deleted when the R session is ended. This behaviour can be altered so that caching is permanent, by setting the caching directory to a non-temporary location. For example, under Windows, use something like:

```{r eval=FALSE}
ala_config(cache_directory="c:/mydata/ala_cache")
```

or for Linux:

```{r eval=FALSE}
ala_config(cache_directory="~/mydata/ala_cache")
```

Note that this directory must exist (you need to create it yourself).

All results will be stored in that cache directory and will be used from one session to the next.


Caching can also be turned off entirely by:

```{r eval=FALSE}
ala_config(caching=FALSE)
```


#### Debugging
If things aren't working as expected, more detail (particularly about web requests and caching behaviour) can be obtained by setting the `verbose` configuration option:

```{r eval=FALSE}
ala_config(verbose=TRUE)
```

#### Setting the download reason
ALA requires that you provide a reason when downloading occurrence data (via the galah `ala_occurrences()` function). The reason is set as "scientific research" by default, but you can change this using `ala_config`. See `ala_reasons()` for valid download reasons.

```{r eval=FALSE}
ala_config(download_reason_id=your_reason_id)
```
